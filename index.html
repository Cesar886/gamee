<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capibara Virtual - Mascota Digital</title>
    <link rel="stylesheet" href="style.css?v=4.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Cuida de tu capibara virtual en esta adorable mascota digital">
    
    <!-- Lottie Web Library -->
    <script src="https://unpkg.com/lottie-web@5.7.4/build/player/lottie.min.js"></script>
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="capibara_normal.png" as="image">
    <link rel="preload" href="capibara_feliz.png" as="image">
    <link rel="preload" href="capibara_saltando.png" as="image">
</head>
<body>
    <div class="game-container">
        <!-- Lottie Animation Container -->
        <div id="capyAnimation"></div>
        
        <!-- Header -->
        <header>
            <div class="header-top">
                <div class="coins-display">
                    <span class="coin-icon">ğŸª™</span>
                    <span id="coinCount">100</span>
                </div>
                <button class="settings-btn" onclick="openSettings()" aria-label="ConfiguraciÃ³n">
                    âš™ï¸
                </button>
            </div>
            <h1>ğŸ¦« Capibara Virtual</h1>
            <p class="subtitle">Tu mascota digital favorita</p>
        </header>

        <!-- NavegaciÃ³n de habitaciones -->
        <nav class="room-navigation">
            <button class="room-btn active" data-room="living" onclick="changeRoom('living')">
                ğŸ <br>Sala
            </button>
            <button class="room-btn" data-room="kitchen" onclick="changeRoom('kitchen')">
                ğŸ½ï¸<br>Cocina
            </button>
            <button class="room-btn" data-room="bedroom" onclick="changeRoom('bedroom')">
                ğŸ›ï¸<br>Cuarto
            </button>
            <button class="room-btn" data-room="game" onclick="changeRoom('game')">
                ğŸ®<br>Juegos
            </button>
            <button class="room-btn" data-room="shop" onclick="changeRoom('shop')">
                ğŸ›’<br>Tienda
            </button>
        </nav>

        <!-- Contenedor de la mascota -->
        <div id="petContainer" class="pet-container living">
            <div class="pet-display">
                <div class="pet-accessories" id="petAccessories"></div>
                <img id="petSprite" class="pet-image" src="capibara_normal.png" alt="Capibara Virtual">
                <h2 id="petName" class="pet-name">Capibara</h2>
                <div id="petMood" class="pet-mood">ğŸ˜Š</div>
            </div>
        </div>

        <!-- EstadÃ­sticas -->
        <div class="stats-container">
            <div class="stat">
                <span class="stat-label">ğŸ Hambre:</span>
                <div class="stat-bar">
                    <div id="hungerBar" class="stat-fill" style="width: 100%"></div>
                </div>
                <span id="hungerValue" class="stat-value">100%</span>
            </div>
            <div class="stat">
                <span class="stat-label">ğŸ˜Š Felicidad:</span>
                <div class="stat-bar">
                    <div id="happinessBar" class="stat-fill" style="width: 100%"></div>
                </div>
                <span id="happinessValue" class="stat-value">100%</span>
            </div>
            <div class="stat">
                <span class="stat-label">â¤ï¸ Salud:</span>
                <div class="stat-bar">
                    <div id="healthBar" class="stat-fill" style="width: 100%"></div>
                </div>
                <span id="healthValue" class="stat-value">100%</span>
            </div>
            <div class="stat">
                <span class="stat-label">âš¡ EnergÃ­a:</span>
                <div class="stat-bar">
                    <div id="energyBar" class="stat-fill" style="width: 100%"></div>
                </div>
                <span id="energyValue" class="stat-value">100%</span>
            </div>
            <div class="stat">
                <span class="stat-label">ğŸ§¼ Limpieza:</span>
                <div class="stat-bar">
                    <div id="cleanlinessBar" class="stat-fill" style="width: 100%"></div>
                </div>
                <span id="cleanlinessValue" class="stat-value">100%</span>
            </div>
        </div>

        <!-- Acciones dinÃ¡micas -->
        <div id="actionsContainer" class="actions-container">
            <!-- Las acciones se generan dinÃ¡micamente segÃºn la habitaciÃ³n -->
        </div>

        <!-- Mensaje de estado -->
        <div id="statusMessage" class="status-message">
            ğŸ˜Š Â¡Tu mascota estÃ¡ feliz y saludable!
        </div>

        <!-- InformaciÃ³n del juego -->
        <div class="game-info">
            <div class="level-progress">
                <div class="level-bar">
                    <div id="levelBar" class="level-fill" style="width: 0%"></div>
                </div>
                <div class="level-text">
                    Nivel <span id="petLevel">1</span> - EXP: <span id="expPoints">0</span>
                </div>
            </div>
            <p>Edad: <span id="petAge">0</span> dÃ­as</p>
            <p>Ãšltima vez alimentada: <span id="lastFed">Nunca</span></p>
            <button class="reset-btn" onclick="resetPet()">ğŸ”„ Reiniciar Mascota</button>
        </div>
    </div>

    <!-- Modal de ConfiguraciÃ³n -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <h3>âš™ï¸ ConfiguraciÃ³n</h3>
            <div class="setting-item">
                <label for="petNameInput">Nombre de la mascota:</label>
                <input type="text" id="petNameInput" maxlength="15" placeholder="Nombre de tu capibara">
            </div>
            <div class="setting-item">
                <label>Color de la mascota:</label>
                <div class="color-options">
                    <button class="color-btn selected" data-color="normal" onclick="changePetColor('normal')">ğŸ¤ Normal</button>
                    <button class="color-btn" data-color="golden" onclick="changePetColor('golden')">ğŸŸ¡ Dorado</button>
                    <button class="color-btn" data-color="pink" onclick="changePetColor('pink')">ğŸ©· Rosa</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="saveSettings()">ğŸ’¾ Guardar</button>
                <button onclick="closeSettings()">âŒ Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Tienda -->
    <div id="shopModal" class="modal-overlay">
        <div class="modal-content shop-content">
            <h3>ğŸ›’ Tienda</h3>
            <div class="shop-tabs">
                <button class="shop-tab active" data-tab="food" onclick="changeShopTab('food')">ğŸ<br>Comida</button>
                <button class="shop-tab" data-tab="accessories" onclick="changeShopTab('accessories')">ğŸ‘’<br>Accesorios</button>
                <button class="shop-tab" data-tab="decorations" onclick="changeShopTab('decorations')">ğŸ¨<br>DecoraciÃ³n</button>
                <button class="shop-tab" data-tab="toys" onclick="changeShopTab('toys')">ğŸ§¸<br>Juguetes</button>
                <button class="shop-tab" data-tab="special" onclick="changeShopTab('special')">âœ¨<br>Especial</button>
            </div>
            <div id="shopItems" class="shop-items">
                <!-- Los items se generan dinÃ¡micamente -->
            </div>
            <button class="close-shop-btn" onclick="closeShop()">ğŸšª Cerrar Tienda</button>
        </div>
    </div>

    <!-- Overlay del Juego de Plataformas -->
    <div id="platformGameOverlay" class="game-overlay">
        <div class="platform-game-container">
            <div class="game-score">PuntuaciÃ³n: <span id="gameScore">0</span></div>
            <canvas id="gameCanvas" width="300" height="500"></canvas>
            
            <!-- Pantalla de inicio -->
            <div id="gameStartScreen" class="game-start-screen">
                <h2>ğŸ® Capibara Jump</h2>
                <p>Â¡Ayuda a tu capibara a saltar lo mÃ¡s alto posible!</p>
                <p>ğŸ“± Toca los lados para moverte<br>ğŸ–±ï¸ Usa las flechas o espacio para saltar</p>
                <button onclick="startGame()">ğŸš€ Comenzar</button>
                <button onclick="closeGame()">âŒ Cerrar</button>
            </div>
            
            <!-- Pantalla de fin de juego -->
            <div id="gameOverScreen" class="game-over-screen" style="display: none;">
                <h2>ğŸ Â¡Juego Terminado!</h2>
                <p>PuntuaciÃ³n: <span id="finalScore">0</span></p>
                <p>Monedas ganadas: <span id="coinsEarned">0</span></p>
                <button onclick="restartGame()">ğŸ”„ Jugar de nuevo</button>
                <button onclick="closeGame()">ğŸšª Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="script.js?v=4.0"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js?v=4.0')
                    .then(function(registration) {
                        console.log('SW registrado con Ã©xito:', registration.scope);
                        
                        // Verificar actualizaciones cada 30 segundos
                        setInterval(() => {
                            registration.update();
                        }, 30000);
                        
                        // Escuchar actualizaciones del service worker
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nueva versiÃ³n disponible
                                    if (confirm('Â¡Nueva versiÃ³n disponible! Â¿Quieres actualizar?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('SW fallÃ³ al registrarse:', error);
                    });
            });
        }

        // Prevenir zoom en dispositivos mÃ³viles
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // Prevenir scroll bounce en iOS
        document.body.addEventListener('touchstart', function (e) {
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const element = touch.target;
                
                // Permitir scroll solo en elementos especÃ­ficos
                if (!element.closest('.shop-items') && !element.closest('input') && !element.closest('textarea')) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        document.body.addEventListener('touchmove', function (e) {
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const element = touch.target;
                
                // Permitir scroll solo en elementos especÃ­ficos
                if (!element.closest('.shop-items') && !element.closest('input') && !element.closest('textarea')) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // FunciÃ³n para crear efectos de partÃ­culas
        function createParticles(x, y, color = '#ffd700', count = 5) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = color;
                particle.style.animationDelay = (i * 0.1) + 's';
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 2000);
            }
        }

        // Agregar efectos de partÃ­culas en clics
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('action-btn') || e.target.classList.contains('shop-item')) {
                createParticles(e.clientX, e.clientY);
            }
        });

        // Detectar instalaciÃ³n de PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar botÃ³n de instalaciÃ³n personalizado despuÃ©s de un tiempo
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwa_install_dismissed')) {
                    const installBanner = document.createElement('div');
                    installBanner.innerHTML = `
                        <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 4000; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-weight: 600;">ğŸ“± Â¡Instala Capibara Virtual!</p>
                            <p style="margin: 0 0 15px 0; font-size: 0.9em; opacity: 0.9;">Accede mÃ¡s rÃ¡pido a tu mascota virtual</p>
                            <button onclick="installPWA()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; margin-right: 10px; cursor: pointer; font-weight: 600;">âœ… Instalar</button>
                            <button onclick="dismissInstall()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer;">âŒ Ahora no</button>
                        </div>
                    `;
                    document.body.appendChild(installBanner);
                }
            }, 10000); // Mostrar despuÃ©s de 10 segundos
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA instalada');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            }
        }

        function dismissInstall() {
            localStorage.setItem('pwa_install_dismissed', 'true');
            const banner = document.querySelector('[style*="position: fixed"]');
            if (banner) {
                banner.remove();
            }
        }

        // Detectar cuando la PWA se instala
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA instalada exitosamente');
            localStorage.setItem('pwa_installed', 'true');
        });
    </script>
</body>
</html>
